<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.58.3" />
    <meta name="description" content="MLOps: Operationalizing Machine Learning">
<meta name="author" content="Theja Tulabandhula">

    <link rel="shortcut icon" href="/MLOps/images/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" sizes="180x180" href="/MLOps/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/MLOps/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/MLOps/images/favicon-16x16.png">
<link rel="manifest" href="/MLOps/images/site.webmanifest">
    <title>Orchestration using ECS and ECR - Part I :: MLOps: Operationalizing Machine Learning</title>

    
    <link href="/MLOps/css/nucleus.css" rel="stylesheet">
    <link href="/MLOps/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/MLOps/css/hybrid.css" rel="stylesheet">
    <link href="/MLOps/css/featherlight.min.css" rel="stylesheet">
    <link href="/MLOps/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/MLOps/css/auto-complete.css" rel="stylesheet">
    <link href="/MLOps/css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="/MLOps/css/theme.css" rel="stylesheet">
    <link href="/MLOps/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/MLOps/css/theme-blue.css" rel="stylesheet">
    

    <script src="/MLOps/js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/MLOps/lecture3/ecr/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a href="/MLOps/"> <img src="/MLOps/images/logo.png" alt="MLOps"></a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/MLOps/js/lunr.min.js"></script>
<script type="text/javascript" src="/MLOps/js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/chicagodatascience.github.io\/MLOps\/";
    
</script>
<script type="text/javascript" src="/MLOps/js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/MLOps/logistics/" title="Course Logistics" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/logistics/">
          <b> </b>Course Logistics
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/MLOps/logistics/online_technology_requirements/" title="Online Learning Details" class="dd-item ">
        <a href="/MLOps/logistics/online_technology_requirements/">
        Online Learning Details
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/logistics/schedule/" title="Schedule" class="dd-item ">
        <a href="/MLOps/logistics/schedule/">
        <b> </b>Schedule
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/logistics/project_instructions/" title="Project" class="dd-item ">
        <a href="/MLOps/logistics/project_instructions/">
        <b> </b>Project
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture1/" title="Lecture 1" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture1/">
          <b> </b>Lecture 1
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/intro/" title="Basics" class="dd-item ">
        <a href="/MLOps/lecture1/intro/">
        <b> 1. </b>Basics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/ssh_and_firewall/" title="SSH and Firewall" class="dd-item ">
        <a href="/MLOps/lecture1/ssh_and_firewall/">
        <b> 2. </b>SSH and Firewall
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/conda/" title="Setting up Python" class="dd-item ">
        <a href="/MLOps/lecture1/conda/">
        <b> 3. </b>Setting up Python
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/jupyter/" title="Remote Jupyter Server" class="dd-item ">
        <a href="/MLOps/lecture1/jupyter/">
        <b> 4. </b>Remote Jupyter Server
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/MLOps/lecture1/recommendation_model/" title="Recommendation Models" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture1/recommendation_model/">
          <b>5. </b>Recommendation Models
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/recommendation_model/surprise_training/" title="Recommendation (SVD) Training" class="dd-item ">
        <a href="/MLOps/lecture1/recommendation_model/surprise_training/">
        <b> </b>Recommendation (SVD) Training
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/recommendation_model/surprise_inference/" title="Recommendation (SVD) Inference" class="dd-item ">
        <a href="/MLOps/lecture1/recommendation_model/surprise_inference/">
        <b> </b>Recommendation (SVD) Inference
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/recommendation_model/pytorch_training/" title="Recommendation (Pytorch) Training" class="dd-item ">
        <a href="/MLOps/lecture1/recommendation_model/pytorch_training/">
        <b> </b>Recommendation (Pytorch) Training
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/recommendation_model/pytorch_inference/" title="Recommendation (Pytorch) Inference" class="dd-item ">
        <a href="/MLOps/lecture1/recommendation_model/pytorch_inference/">
        <b> </b>Recommendation (Pytorch) Inference
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/deploy_webserver/" title="Serving ML Models Using Web Servers" class="dd-item ">
        <a href="/MLOps/lecture1/deploy_webserver/">
        <b> 6. </b>Serving ML Models Using Web Servers
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/flask/" title="Flask App" class="dd-item ">
        <a href="/MLOps/lecture1/flask/">
        <b> 7. </b>Flask App
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture1/exercises/" title="Exercises" class="dd-item ">
        <a href="/MLOps/lecture1/exercises/">
        <b> </b>Exercises
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture2/" title="Lecture 2" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture2/">
          <b> </b>Lecture 2
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture2/serverless/" title="Serverless Deployments" class="dd-item ">
        <a href="/MLOps/lecture2/serverless/">
        <b>1. </b>Serverless Deployments
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture2/cloud_functions/" title="Cloud Functions" class="dd-item ">
        <a href="/MLOps/lecture2/cloud_functions/">
        <b>2. </b>Cloud Functions
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture2/cloud_functions_model/" title="GCP Serverless Model Serving" class="dd-item ">
        <a href="/MLOps/lecture2/cloud_functions_model/">
        <b>3. </b>GCP Serverless Model Serving
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture2/lambda_functions/" title="Lambda Functions" class="dd-item ">
        <a href="/MLOps/lecture2/lambda_functions/">
        <b>4. </b>Lambda Functions
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture2/lambda_functions_model/" title="AWS Serverless Model Serving" class="dd-item ">
        <a href="/MLOps/lecture2/lambda_functions_model/">
        <b>5. </b>AWS Serverless Model Serving
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture2/exercises/" title="Exercises" class="dd-item ">
        <a href="/MLOps/lecture2/exercises/">
        <b> </b>Exercises
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture3/" title="Lecture 3" class="dd-item 
        parent
        
        
        ">
      <a href="/MLOps/lecture3/">
          <b> </b>Lecture 3
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture3/intro/" title="Introduction" class="dd-item ">
        <a href="/MLOps/lecture3/intro/">
        <b>1. </b>Introduction
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture3/docker/" title="Docker" class="dd-item ">
        <a href="/MLOps/lecture3/docker/">
        <b>2. </b>Docker
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture3/ecr/" title="Orchestration using ECS and ECR - Part I" class="dd-item active">
        <a href="/MLOps/lecture3/ecr/">
        <b>3. </b>Orchestration using ECS and ECR - Part I
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture3/ecs/" title="Orchestration using ECS and ECR - Part II" class="dd-item ">
        <a href="/MLOps/lecture3/ecs/">
        <b>4. </b>Orchestration using ECS and ECR - Part II
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture3/exercises/" title="Exercises" class="dd-item ">
        <a href="/MLOps/lecture3/exercises/">
        <b> </b>Exercises
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture4/" title="Lecture 4" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture4/">
          <b> </b>Lecture 4
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture4/kubernetes/" title="Kubernetes" class="dd-item ">
        <a href="/MLOps/lecture4/kubernetes/">
        <b>5. </b>Kubernetes
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/MLOps/lecture4/gke/" title="Orchestration using GKE" class="dd-item ">
        <a href="/MLOps/lecture4/gke/">
        <b>6. </b>Orchestration using GKE
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture5/" title="Lecture 5" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture5/">
          <b> </b>Lecture 5
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture6/" title="Lecture 6" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture6/">
          <b> </b>Lecture 6
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture7/" title="Lecture 7" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture7/">
          <b> </b>Lecture 7
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/MLOps/lecture8/" title="Lecture 8" class="dd-item 
        
        
        
        ">
      <a href="/MLOps/lecture8/">
          <b> </b>Lecture 8
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    <section id="footer">
      



<i class='fab fa-fw fa-github'></i> <a href="https://github.com/chicagodatascience/MLOps/"> GitHub repo</a>
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Orchestration using ECS and ECR - Part I 
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#intro">Intro</a></li>
<li><a href="#elastic-container-registry-ecr">Elastic Container Registry (ECR)</a></li>
<li><a href="#creating-the-model-prediction-docker-image">Creating the Model Prediction Docker Image</a></li>
<li><a href="#sending-our-docker-image-to-ecr">Sending our Docker Image to ECR</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Orchestration using ECS and ECR - Part I
            </h1>
          

        





<h3 id="intro">Intro</h3>

<blockquote>
<p>Orchestration means managing container life cycle from building them to deploying (which requires provisioning of appropriate compute resources, storage resources, networking resources), scaling, load-balancing and other tasks, while accounting for failures throughout.</p>
</blockquote>

<p>While there are many orchestration solutions, we will focus on a couple of them: ECS by AWS and Kubernetes (local hosted solution and managed by GCP). While there is Elastic Kubernetes Service (EKS) by AWS as well, we will omit it here, as the ideas are the same.</p>

<p>Why should data science professions know such orchestration solutions?</p>

<ul>
<li>Pro: Get key devops features (fault tolerance, scalability etc) with low on-going effort. The deployed service will not likely break down.</li>
<li>Con: There is a non-trivial setup cost/complexity.</li>
</ul>

<p>Next, we will (a) deploy our model serving docker image to the AWS container registry ECR, (b) use ECS to deploy a container based on that image, and &copy; set up a load balancer that mediates requests to the prediction model.</p>

<h3 id="elastic-container-registry-ecr">Elastic Container Registry (ECR)</h3>

<ul>
<li>Sending the image to a model registry such as ECR is needed to access it at other places to create containers.</li>
<li>ECR allows for better integration with the AWS platform, and works with EKS as well.</li>

<li><p>We will create a docker image locally (can also be done on EC2) and <em>push it</em> to an ECR repository that we will create.</p></li>

<li><p>Navigate to the ECR link on the AWS console.</p></li>
</ul>

<p><img src="ecr_create0.png" alt="ecr_create0" /></p>

<ul>
<li>Click create a repository &lsquo;Get Started&rsquo; button. ECR can have multiple repositories and each repository can hold multiple images.</li>
</ul>

<p><img src="ecr_create1.png" alt="ecr_create1" /></p>

<ul>
<li>Give a name to the repository. It will contain multiple Docker images.</li>
</ul>

<p><img src="ecr_create2.png" alt="ecr_create2" /></p>

<ul>
<li>Review the current repository list.</li>
</ul>

<p><img src="ecr_create3.png" alt="ecr_create3" /></p>

<ul>
<li>Next we will allow the programmatic user we created for accessing S3 (we gave the user name model-user) to also manage the ECR repositories. Navigate to IAM as shown below.</li>
</ul>

<p><img src="iam_ecr1.png" alt="iam_ecr1" /></p>

<ul>
<li>Click on the user who we want to edit access controls for.</li>
</ul>

<p><img src="iam_ecr2.png" alt="iam_ecr2" /></p>

<ul>
<li>Currently this user had S3 access (not relevant for us).</li>
</ul>

<p><img src="iam_ecr3.png" alt="iam_ecr3" /></p>

<ul>
<li>Click on attaching existing policies and search for <code>AmazonEC2ContainerRegistryFullAccess</code>.</li>
</ul>

<p><img src="iam_ecr4.png" alt="iam_ecr4" /></p>

<ul>
<li>Review your policy choice and proceed.</li>
</ul>

<p><img src="iam_ecr5.png" alt="iam_ecr5" /></p>

<ul>
<li>You can see the summary of permissions that this programmatic user has.</li>
</ul>

<p><img src="iam_ecr6.png" alt="iam_ecr6" /></p>

<h3 id="creating-the-model-prediction-docker-image">Creating the Model Prediction Docker Image</h3>

<ul>
<li><p>We will use the following flask app that uses the pytorch model to serve recommendations:</p>

<pre><code class="language-python">from surprise import Dataset
import torch
import pandas as pd
import flask

class MF(torch.nn.Module):
    
def __init__(self, n_user, n_item, k=18, c_vector=1.0, c_bias=1.0):
    super(MF, self).__init__()
    self.k = k
    self.n_user = n_user
    self.n_item = n_item
    self.c_bias = c_bias
    self.c_vector = c_vector
        
    self.user = torch.nn.Embedding(n_user, k)
    self.item = torch.nn.Embedding(n_item, k)
        
    # We've added new terms here:
    self.bias_user = torch.nn.Embedding(n_user, 1)
    self.bias_item = torch.nn.Embedding(n_item, 1)
    self.bias = torch.nn.Parameter(torch.ones(1))
    
def __call__(self, train_x):
    user_id = train_x[:, 0]
    item_id = train_x[:, 1]
    vector_user = self.user(user_id)
    vector_item = self.item(item_id)
        
    # Pull out biases
    bias_user = self.bias_user(user_id).squeeze()
    bias_item = self.bias_item(item_id).squeeze()
    biases = (self.bias + bias_user + bias_item)
        
    ui_interaction = torch.sum(vector_user * vector_item, dim=1)
        
    # Add bias prediction to the interaction prediction
    prediction = ui_interaction + biases
    return prediction
    
def loss(self, prediction, target):
    loss_mse = F.mse_loss(prediction, target.squeeze())
        
    # Add new regularization to the biases
    prior_bias_user =  l2_regularize(self.bias_user.weight) * self.c_bias
    prior_bias_item = l2_regularize(self.bias_item.weight) * self.c_bias
        
    prior_user =  l2_regularize(self.user.weight) * self.c_vector
    prior_item = l2_regularize(self.item.weight) * self.c_vector
    total = loss_mse + prior_user + prior_item + prior_bias_user + prior_bias_item
    return total

def get_top_n(model,testset,trainset,uid_input,n=10):
    
preds = []
try:
    uid_input = int(trainset.to_inner_uid(uid_input))
except KeyError:
    return preds        

# First map the predictions to each user.
for uid, iid, _ in testset: #inefficient
    try:
        uid_internal = int(trainset.to_inner_uid(uid))
    except KeyError:
        continue
    if uid_internal==uid_input:
        try:
            iid_internal = int(trainset.to_inner_iid(iid))
            movie_name = df.loc[int(iid),'name']
            preds.append((iid,movie_name,float(model(torch.tensor([[uid_input,iid_internal]])))))
        except KeyError:
            pass
# Then sort the predictions for each user and retrieve the k highest ones
if preds is not None:
    preds.sort(key=lambda x: x[1], reverse=True)
    if len(preds) &gt; n:
        preds = preds[:n]
return preds


app = flask.Flask(__name__)


#Data
df = pd.read_csv('./movies.dat',sep=&quot;::&quot;,header=None,engine='python')
df.columns = ['iid','name','genre']
df.set_index('iid',inplace=True)
data = Dataset.load_builtin('ml-100k',prompt=False) 
'''
Exercise: remove the above dependency. 
Currently it downloads data from grouplens website and stores in .surprise folder in $HOME
'''
trainset = data.build_full_trainset()
testset = trainset.build_anti_testset()

#Parameters that are needed to reload the model from disk
k = 10 #latent dimension
c_bias = 1e-6
c_vector = 1e-6
model = MF(trainset.n_users, trainset.n_items, k=k, c_bias=c_bias, c_vector=c_vector)
model.load_state_dict(torch.load('./pytorch_model'))
model.eval() #no need for gradient computations in this setting


# define a predict function as an endpoint
@app.route(&quot;/&quot;, methods=[&quot;GET&quot;])
def predict():
data = {&quot;success&quot;: False}

# check for passed in parameters   
params = flask.request.json
if params is None:
    params = flask.request.args
    
if &quot;uid&quot; in params.keys():
    data[&quot;response&quot;] = get_top_n(model,testset,trainset,params['uid'],n=10) 
    data[&quot;success&quot;] = True
        
# return a response in json format 
return flask.jsonify(data)


# start the flask app, allow remote connections
app.run(host='0.0.0.0', port=80)
</code></pre></li>

<li><p>The corresponding Dockerfile is below. The key additional files in addition to <code>recommend.py</code> above are:</p>

<ul>
<li>movies.dat</li>

<li><p>pytorch_model</p>

<pre><code class="language-bash">FROM continuumio/miniconda3:latest

RUN conda install -y flask pandas \
&amp;&amp; conda install -c conda-forge scikit-surprise \
&amp;&amp; conda install pytorch torchvision cpuonly -c pytorch 

COPY recommend.py recommend.py
COPY movies.dat movies.dat
COPY pytorch_model pytorch_model

ENTRYPOINT [&quot;python&quot;,&quot;recommend.py&quot;]
</code></pre></li>
</ul></li>

<li><p>The miniconda image above is from <a href="https://hub.docker.com/r/continuumio/miniconda3">https://hub.docker.com/r/continuumio/miniconda3</a>.</p></li>

<li><p>Building an image based on the above file and running our prediction locally can be done using the following commands:</p>

<pre><code class="language-bash">docker image build -t &quot;prediction_service&quot; .
docker run -d -p 5000:5000 prediction_service
docker ps -a #check what all containers were/are running
docker kill container_id #after checking that the service runs, we can safely stop and delete the container.
docker rm container_id
</code></pre></li>

<li><p>If we run a container based on this image, the python file and others will be in the root (<code>/</code>) folder and will be run by the root user. While we will not improve this here, it is better to run services as non-root users.</p></li>
</ul>

<h3 id="sending-our-docker-image-to-ecr">Sending our Docker Image to ECR</h3>

<ul>
<li><p>We will follow the instruction <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html">here</a> to push our image to the repository we just created.</p></li>

<li><p>Assuming you have the aws CLI configured with the secret keys, run the following command:</p>

<pre><code class="language-bash">aws ecr get-login-password --region region | docker login --username AWS --password-stdin aws_account_id.dkr.ecr.region.amazonaws.com
</code></pre></li>

<li><p>Substitute <code>region</code> with <code>us-east-1</code> etc (check the URL on the ECR page) as well as <code>aws_account_id</code> with the actual account id. We should get a prompt saying &lsquo;Login Succeeded&rsquo;.</p></li>

<li><p>Lets tag our image before sending it to ECR (replace account id and region below as well):</p>

<pre><code class="language-bash">(datasci-dev) ttmac:docker-prediction-service theja$ docker tag prediction_service aws_account_id.dkr.ecr.region.amazonaws.com/models:recommendations
(datasci-dev) ttmac:docker-prediction-service theja$ docker images
REPOSITORY                                            TAG                 IMAGE ID            CREATED             SIZE
aws_account_id.dkr.ecr.region.amazonaws.com/recommendations   pytorch_model       364179b27eb1        21 minutes ago      2.06GB
weather_service                                                latest              20d340f941c0        2 days ago          496MB
debian                                                         buster-slim         c7346dd7f20e        5 weeks ago         69.2MB
continuumio/miniconda3                                         latest              b4adc22212f1        6 months ago        429MB
hello-world                                                    latest              bf756fb1ae65        8 months ago        13.3kB
</code></pre></li>

<li><p>Pushing to ECR is achieved by the following:</p>

<pre><code class="language-bash">docker push aws_account_id.dkr.region.amazonaws.com/recommendations:pytorch_model
</code></pre></li>

<li><p>You should see the update progress (this is a large upload!)</p>

<pre><code class="language-bash">The push refers to repository [aws_account_id.dkr.ecr.us-east-2.amazonaws.com/recommendations]
a5649bbe3e5f: Pushed
5c87fc4d582f: Pushed
e1e8d92205bf: Pushed
5c6c81390816: Pushing [=========================&gt;                         ]  848.8MB/1.635GB
fcd8d39597dd: Pushed
875120aa853c: Pushed
f2cb0ecef392: Pushed
</code></pre></li>

<li><p>And the push conclusion:</p>

<pre><code class="language-bash">(datasci-dev) ttmac:docker-prediction-service theja$ docker push aws_account_id.dkr.ecr.us-east-2.amazonaws.com/recommendations:pytorch_model
The push refers to repository [aws_account_id.dkr.ecr.us-east-2.amazonaws.com/recommendations]
a5649bbe3e5f: Pushed
5c87fc4d582f: Pushed
e1e8d92205bf: Pushed
5c6c81390816: Pushed
fcd8d39597dd: Pushed
875120aa853c: Pushed
f2cb0ecef392: Pushed
pytorch_model: digest: sha256:af5dfaf227cd96c4ca8ca952c511fb4274c59d76574726462137bc7c4230be07 size: 1793
</code></pre></li>

<li><p>On the ECR page, if we look at the images in the recommendations repository, it will contain our recently uploaded image.</p></li>
</ul>

<p><img src="ecr_image1.png" alt="ecr_image1" /></p>

<ul>
<li>There is a friendly help box that details specific (to your account) commands for pushing images to ECR on the above page as well. You could use that as a guiding reference, or the <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html">help</a> page.</li>
</ul>

<p><img src="ecr_push.png" alt="ecr_push" /></p>


<footer class="footline">
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/MLOps/lecture3/docker/" title="Docker"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/MLOps/lecture3/ecs/" title="Orchestration using ECS and ECR - Part II" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/MLOps/js/clipboard.min.js"></script>
    <script src="/MLOps/js/perfect-scrollbar.min.js"></script>
    <script src="/MLOps/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/MLOps/js/jquery.sticky.js"></script>
    <script src="/MLOps/js/featherlight.min.js"></script>
    <script src="/MLOps/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/MLOps/js/modernizr.custom-3.6.0.js"></script>
    <script src="/MLOps/js/learn.js"></script>
    <script src="/MLOps/js/hugo-learn.js"></script>

    <link href="/MLOps/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/MLOps/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-156050402-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-156050402-2');
</script>




<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">

  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
  TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>

  </body>
</html>

